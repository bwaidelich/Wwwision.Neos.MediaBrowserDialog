!function(b,a){"object"==typeof exports&&"undefined"!=typeof module?module.exports=a():"function"==typeof define&&define.amd?define(a):(b=b||self).dialogPolyfill=a()}(this,function(){"use strict";var c=window.CustomEvent;function g(a,b){var c="on"+b.type.toLowerCase();return"function"==typeof a[c]&&a[c](b),a.dispatchEvent(b)}function h(a){for(;a;){if("dialog"===a.localName)return a;a=a.parentElement?a.parentElement:a.parentNode?a.parentNode.host:null}return null}function i(a){for(;a&&a.shadowRoot&&a.shadowRoot.activeElement;)a=a.shadowRoot.activeElement;a&&a.blur&&a!==document.body&&a.blur()}function j(b,c){for(var a=0;a<b.length;++a)if(b[a]===c)return!0;return!1}function k(a){return!!(a&&a.hasAttribute("method"))&&"dialog"===a.getAttribute("method").toLowerCase()}function l(d){var e=["button","input","keygen","select","textarea"].map(function(a){return a+":not([disabled])"});e.push('[tabindex]:not([disabled]):not([tabindex=""])');var c=d.querySelector(e.join(", "));if(!c&&"attachShadow"in Element.prototype)for(var b=d.querySelectorAll("*"),a=0;a<b.length&&!(b[a].tagName&&b[a].shadowRoot&&(c=l(b[a].shadowRoot)));a++);return c}function m(a){return a.isConnected||document.body.contains(a)}function n(c){if(c.submitter)return c.submitter;var d=c.target;if(!(d instanceof HTMLFormElement))return null;var b=a.formSubmitter;if(!b){var e=c.target;b=("getRootNode"in e&&e.getRootNode()||document).activeElement}return b&&b.form===d?b:null}function o(b){if(!b.defaultPrevented){var f=b.target,c=a.imagemapUseValue,d=n(b);null===c&&d&&(c=d.value);var e=h(f);e&&"dialog"===(d&&d.getAttribute("formmethod")||f.getAttribute("method"))&&(b.preventDefault(),null!=c?e.close(c):e.close())}}function e(a){if(this.dialog_=a,this.replacedStyleTop_=!1,this.openAsModal_=!1,a.hasAttribute("role")||a.setAttribute("role","dialog"),a.show=this.show.bind(this),a.showModal=this.showModal.bind(this),a.close=this.close.bind(this),a.addEventListener("submit",o,!1),"returnValue"in a||(a.returnValue=""),"MutationObserver"in window)new MutationObserver(this.maybeHideModal.bind(this)).observe(a,{attributes:!0,attributeFilter:["open"]});else{var b,c=!1,d=(function(){c?this.downgradeModal():this.maybeHideModal(),c=!1}).bind(this),e=function(e){if(e.target===a){var f="DOMNodeRemoved";c|=e.type.substr(0,f.length)===f,window.clearTimeout(b),b=window.setTimeout(d,0)}};["DOMAttrModified","DOMNodeRemoved","DOMNodeRemovedFromDocument"].forEach(function(b){a.addEventListener(b,e)})}Object.defineProperty(a,"open",{set:this.setOpen.bind(this),get:a.hasAttribute.bind(a,"open")}),this.backdrop_=document.createElement("div"),this.backdrop_.className="backdrop",this.backdrop_.addEventListener("mouseup",this.backdropMouseEvent_.bind(this)),this.backdrop_.addEventListener("mousedown",this.backdropMouseEvent_.bind(this)),this.backdrop_.addEventListener("click",this.backdropMouseEvent_.bind(this))}c&&"object"!=typeof c||((c=function(c,a){a=a||{};var b=document.createEvent("CustomEvent");return b.initCustomEvent(c,!!a.bubbles,!!a.cancelable,a.detail||null),b}).prototype=window.Event.prototype),e.prototype={get dialog(){return this.dialog_},maybeHideModal:function(){this.dialog_.hasAttribute("open")&&m(this.dialog_)||this.downgradeModal()},downgradeModal:function(){this.openAsModal_&&(this.openAsModal_=!1,this.dialog_.style.zIndex="",this.replacedStyleTop_&&(this.dialog_.style.top="",this.replacedStyleTop_=!1),this.backdrop_.parentNode&&this.backdrop_.parentNode.removeChild(this.backdrop_),a.dm.removeDialog(this))},setOpen:function(a){a?this.dialog_.hasAttribute("open")||this.dialog_.setAttribute("open",""):(this.dialog_.removeAttribute("open"),this.maybeHideModal())},backdropMouseEvent_:function(a){if(this.dialog_.hasAttribute("tabindex"))this.dialog_.focus();else{var b=document.createElement("div");this.dialog_.insertBefore(b,this.dialog_.firstChild),b.tabIndex=-1,b.focus(),this.dialog_.removeChild(b)}var c=document.createEvent("MouseEvents");c.initMouseEvent(a.type,a.bubbles,a.cancelable,window,a.detail,a.screenX,a.screenY,a.clientX,a.clientY,a.ctrlKey,a.altKey,a.shiftKey,a.metaKey,a.button,a.relatedTarget),this.dialog_.dispatchEvent(c),a.stopPropagation()},focus_:function(){var a=this.dialog_.querySelector("[autofocus]:not([disabled])");!a&&this.dialog_.tabIndex>=0&&(a=this.dialog_),a||(a=l(this.dialog_)),i(document.activeElement),a&&a.focus()},updateZIndex:function(a,b){if(a<b)throw new Error("dialogZ should never be < backdropZ");this.dialog_.style.zIndex=a,this.backdrop_.style.zIndex=b},show:function(){this.dialog_.open||(this.setOpen(!0),this.focus_())},showModal:function(){if(this.dialog_.hasAttribute("open"))throw new Error("Failed to execute 'showModal' on dialog: The element is already open, and therefore cannot be opened modally.");if(!m(this.dialog_))throw new Error("Failed to execute 'showModal' on dialog: The element is not in a Document.");if(!a.dm.pushDialog(this))throw new Error("Failed to execute 'showModal' on dialog: There are too many open modal dialogs.");(function(a){for(;a&&a!==document.body;){var c=window.getComputedStyle(a),b=function(a,b){return!(void 0===c[a]||c[a]===b)};if(c.opacity<1||b("zIndex","auto")||b("transform","none")||b("mixBlendMode","normal")||b("filter","none")||b("perspective","none")||"isolate"===c.isolation||"fixed"===c.position||"touch"===c.webkitOverflowScrolling)return!0;a=a.parentElement}return!1})(this.dialog_.parentElement)&&console.warn("A dialog is being shown inside a stacking context. This may cause it to be unusable. For more information, see this link: https://github.com/GoogleChrome/dialog-polyfill/#stacking-context"),this.setOpen(!0),this.openAsModal_=!0,a.needsCentering(this.dialog_)?(a.reposition(this.dialog_),this.replacedStyleTop_=!0):this.replacedStyleTop_=!1,this.dialog_.parentNode.insertBefore(this.backdrop_,this.dialog_.nextSibling),this.focus_()},close:function(a){if(!this.dialog_.hasAttribute("open"))throw new Error("Failed to execute 'close' on dialog: The element does not have an 'open' attribute, and therefore cannot be closed.");this.setOpen(!1),void 0!==a&&(this.dialog_.returnValue=a);var b=new c("close",{bubbles:!1,cancelable:!1});g(this.dialog_,b)}};var a={};if(a.reposition=function(a){var b=document.body.scrollTop||document.documentElement.scrollTop,c=b+(window.innerHeight-a.offsetHeight)/2;a.style.top=Math.max(b,c)+"px"},a.isInlinePositionSetByStylesheet=function(h){for(var b=0;b<document.styleSheets.length;++b){var i=document.styleSheets[b],a=null;try{a=i.cssRules}catch(k){}if(a)for(var c=0;c<a.length;++c){var d=a[c],e=null;try{e=document.querySelectorAll(d.selectorText)}catch(l){}if(e&&j(e,h)){var f=d.style.getPropertyValue("top"),g=d.style.getPropertyValue("bottom");if(f&&"auto"!==f||g&&"auto"!==g)return!0}}}return!1},a.needsCentering=function(b){return"absolute"===window.getComputedStyle(b).position&&("auto"===b.style.top||""===b.style.top)&&("auto"===b.style.bottom||""===b.style.bottom)&&!a.isInlinePositionSetByStylesheet(b)},a.forceRegisterDialog=function(a){if((window.HTMLDialogElement||a.showModal)&&console.warn("This browser already supports <dialog>, the polyfill may not work correctly",a),"dialog"!==a.localName)throw new Error("Failed to register dialog: The element is not a dialog.");new e(a)},a.registerDialog=function(b){b.showModal||a.forceRegisterDialog(b)},a.DialogManager=function(){this.pendingDialogStack=[];var a=this.checkDOM_.bind(this);this.overlay=document.createElement("div"),this.overlay.className="_dialog_overlay",this.overlay.addEventListener("click",(function(b){this.forwardTab_=void 0,b.stopPropagation(),a([])}).bind(this)),this.handleKey_=this.handleKey_.bind(this),this.handleFocus_=this.handleFocus_.bind(this),this.zIndexLow_=1e5,this.zIndexHigh_=100150,this.forwardTab_=void 0,"MutationObserver"in window&&(this.mo_=new MutationObserver(function(c){var b=[];c.forEach(function(d){for(var a,c=0;a=d.removedNodes[c];++c)a instanceof Element&&("dialog"===a.localName&&b.push(a),b=b.concat(a.querySelectorAll("dialog")))}),b.length&&a(b)}))},a.DialogManager.prototype.blockDocument=function(){document.documentElement.addEventListener("focus",this.handleFocus_,!0),document.addEventListener("keydown",this.handleKey_),this.mo_&&this.mo_.observe(document,{childList:!0,subtree:!0})},a.DialogManager.prototype.unblockDocument=function(){document.documentElement.removeEventListener("focus",this.handleFocus_,!0),document.removeEventListener("keydown",this.handleKey_),this.mo_&&this.mo_.disconnect()},a.DialogManager.prototype.updateStacking=function(){for(var c,a=this.zIndexHigh_,b=0;c=this.pendingDialogStack[b];++b)c.updateZIndex(--a,--a),0===b&&(this.overlay.style.zIndex=--a);var d=this.pendingDialogStack[0];d?(d.dialog.parentNode||document.body).appendChild(this.overlay):this.overlay.parentNode&&this.overlay.parentNode.removeChild(this.overlay)},a.DialogManager.prototype.containedByTopDialog_=function(a){for(;a=h(a);){for(var c,b=0;c=this.pendingDialogStack[b];++b)if(c.dialog===a)return 0===b;a=a.parentElement}return!1},a.DialogManager.prototype.handleFocus_=function(a){var b=a.composedPath?a.composedPath()[0]:a.target;if(!this.containedByTopDialog_(b)&&document.activeElement!==document.documentElement&&(a.preventDefault(),a.stopPropagation(),i(b),void 0!==this.forwardTab_)){var c=this.pendingDialogStack[0];return c.dialog.compareDocumentPosition(b)&Node.DOCUMENT_POSITION_PRECEDING&&(this.forwardTab_?c.focus_():b!==document.documentElement&&document.documentElement.focus()),!1}},a.DialogManager.prototype.handleKey_=function(a){if(this.forwardTab_=void 0,27===a.keyCode){a.preventDefault(),a.stopPropagation();var d=new c("cancel",{bubbles:!1,cancelable:!0}),b=this.pendingDialogStack[0];b&&g(b.dialog,d)&&b.dialog.close()}else 9===a.keyCode&&(this.forwardTab_=!a.shiftKey)},a.DialogManager.prototype.checkDOM_=function(a){this.pendingDialogStack.slice().forEach(function(b){-1!==a.indexOf(b.dialog)?b.downgradeModal():b.maybeHideModal()})},a.DialogManager.prototype.pushDialog=function(a){var b=(this.zIndexHigh_-this.zIndexLow_)/2-1;return!(this.pendingDialogStack.length>=b)&&(1===this.pendingDialogStack.unshift(a)&&this.blockDocument(),this.updateStacking(),!0)},a.DialogManager.prototype.removeDialog=function(b){var a=this.pendingDialogStack.indexOf(b);-1!==a&&(this.pendingDialogStack.splice(a,1),0===this.pendingDialogStack.length&&this.unblockDocument(),this.updateStacking())},a.dm=new a.DialogManager,a.formSubmitter=null,a.imagemapUseValue=null,void 0===window.HTMLDialogElement){var d=document.createElement("form");if(d.setAttribute("method","dialog"),"dialog"!==d.method){var b=Object.getOwnPropertyDescriptor(HTMLFormElement.prototype,"method");if(b){var p=b.get;b.get=function(){return k(this)?"dialog":p.call(this)};var q=b.set;b.set=function(a){return"string"==typeof a&&"dialog"===a.toLowerCase()?this.setAttribute("method",a):q.call(this,a)},Object.defineProperty(HTMLFormElement.prototype,"method",b)}}document.addEventListener("click",function(c){if(a.formSubmitter=null,a.imagemapUseValue=null,!c.defaultPrevented){var b=c.target;if("composedPath"in c&&(b=c.composedPath().shift()||b),b&&k(b.form)){if(!("submit"===b.type&&["button","input"].indexOf(b.localName)> -1)){if(!("input"===b.localName&&"image"===b.type))return;a.imagemapUseValue=c.offsetX+","+c.offsetY}h(b)&&(a.formSubmitter=b)}}},!1),document.addEventListener("submit",function(a){var b=a.target;if(!h(b)){var c=n(a);"dialog"===(c&&c.getAttribute("formmethod")||b.getAttribute("method"))&&a.preventDefault()}});var r=HTMLFormElement.prototype.submit,f=function(){if(!k(this))return r.call(this);var a=h(this);a&&a.close()};HTMLFormElement.prototype.submit=f}return a}),window.addEventListener("DOMContentLoaded",()=>{function a(a){a.querySelectorAll("[data-asset-browse]").forEach(b=>{b.addEventListener("click",async e=>{e.preventDefault();let f="assetConstraintsAssetSources"in a.dataset?a.dataset.assetConstraintsAssetSources.split(","):[],g="assetConstraintsMediaTypes"in a.dataset?a.dataset.assetConstraintsMediaTypes.split(","):[],b=await d(f,g,a);b&&(a.dataset.asset=b,a.dispatchEvent(new CustomEvent("assetChosen",{detail:b})),await c(a))})}),a.querySelectorAll("[data-asset-replace]").forEach(b=>{b.addEventListener("click",async b=>{b.preventDefault(),a.dataset.asset="",a.dispatchEvent(new CustomEvent("assetRemoved")),await c(a)})})}async function b(b){let c=await fetch(`/neos/service/assets/${b}`),d=await c.text(),e=new DOMParser,a=e.parseFromString(d,"text/html"),f=a.querySelector("label.asset-label").textContent,g=a.querySelector('a[rel="preview"]').getAttribute("href");return{label:f,previewUrl:g}}async function c(a){let e=a.dataset.asset,f=e.length>0,g=a.querySelector("[data-asset-field]");if(g&&(g.value=f?e:"",g.disabled=!f),a.querySelectorAll("[data-asset-hide-if-set]").forEach(a=>a.style.display=f?"none":""),a.querySelectorAll("[data-asset-hide-if-missing]").forEach(a=>a.style.display=f?"":"none"),!f)return;let c=a.querySelector("img[data-asset-preview-image]"),d=a.querySelector("[data-asset-preview-label]");if(c||d){c&&c.setAttribute("src",""),d&&(d.textContent="");let{label:h,previewUrl:i}=await b(e);c&&c.setAttribute("src",i),d&&(d.textContent=h)}}async function d(a,b,c){return new Promise(h=>{let f=c.dataset.asset,g=f?new URL("/neos/media/browser/images/edit.html?asset="+f,window.location.origin):new URL("/neos/media/browser/assets/index.html",window.location.origin);a.map(a=>g.searchParams.append("constraints[assetSources][]",a.trim())),b.map(a=>g.searchParams.append("constraints[mediaTypes][]",a.trim()));let d=document.createElement("dialog");d.style.padding="0",d.style.width="90%",d.style.height="720px";let e=document.createElement("iframe");e.setAttribute("src",g.toString()),e.style.position="absolute",e.style.width="100%",e.style.height="100%",e.style.borderWidth="0",e.style.backgroundColor="#222",d.appendChild(e),window.NeosMediaBrowserCallbacks={assetChosen(a){h(a),d.close()}},d.addEventListener("cancel",a=>h(null)),c.appendChild(d),dialogPolyfill.registerDialog(d),d.showModal()})}document.querySelectorAll("[data-asset]").forEach(async b=>{a(b),await c(b,b.dataset.asset)})})
